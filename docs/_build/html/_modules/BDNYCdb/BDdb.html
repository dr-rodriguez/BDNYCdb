

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>BDNYCdb.BDdb &mdash; BDNYCdb 0.1.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="BDNYCdb 0.1.0 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> BDNYCdb
          

          
          </a>

          
            
            
              <div class="version">
                0.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../BDdb.html">BDdb module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utilities.html">utilities module</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">BDNYCdb</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>BDNYCdb.BDdb</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for BDNYCdb.BDdb</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/python</span>
<span class="c"># BDNYC database</span>
<span class="kn">import</span> <span class="nn">io</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">itertools</span><span class="o">,</span> <span class="nn">warnings</span><span class="o">,</span> <span class="nn">sqlite3</span> <span class="kn">as</span> <span class="nn">sql</span><span class="o">,</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span><span class="o">,</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span><span class="o">,</span> <span class="nn">astropy.io.fits</span> <span class="kn">as</span> <span class="nn">pf</span><span class="o">,</span> <span class="nn">utilities</span> <span class="kn">as</span> <span class="nn">u</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s">&#39;ignore&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="get_db"><a class="viewcode-back" href="../../BDNYCdb.html#BDNYCdb.BDdb.get_db">[docs]</a><span class="k">class</span> <span class="nc">get_db</span><span class="p">:</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbpath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the database.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dbpath: str </span>
<span class="sd">      The path to the database file. </span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    object</span>
<span class="sd">      The database object</span>
<span class="sd">         </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dbpath</span><span class="p">):</span>
      <span class="k">def</span> <span class="nf">dict_factory</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">description</span><span class="p">):</span> <span class="n">d</span><span class="p">[</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">d</span>
    
      <span class="n">con</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dbpath</span><span class="p">,</span> <span class="n">isolation_level</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">detect_types</span><span class="o">=</span><span class="n">sql</span><span class="o">.</span><span class="n">PARSE_DECLTYPES</span><span class="p">)</span>
      <span class="n">con</span><span class="o">.</span><span class="n">text_factory</span> <span class="o">=</span> <span class="nb">str</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">modify</span> <span class="o">=</span> <span class="n">con</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">query_list</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">query_dict</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">query_dict</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="n">dict_factory</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_list</span><span class="o">.</span><span class="n">execute</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_dict</span><span class="o">.</span><span class="n">execute</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;Sorry, no such file &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbpath</span><span class="p">)</span>
        
<div class="viewcode-block" id="get_db.add_data"><a class="viewcode-back" href="../../BDNYCdb.html#BDNYCdb.BDdb.get_db.add_data">[docs]</a>  <span class="k">def</span> <span class="nf">add_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CSV</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds data in **CSV** file to the specified database **table**. Note column names (row 1 of CSV file) must match table fields to insert, however order and completeness don&#39;t matter.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    CSV: str</span>
<span class="sd">      The path to the .csv file to be read in.</span>
<span class="sd">    table: str</span>
<span class="sd">      The name of the table into which the data should be inserted    </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Digest the csv file into Python </span>
    <span class="n">data</span><span class="p">,</span> <span class="n">insert</span><span class="p">,</span> <span class="n">update</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">CSV</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;,&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="p">[],</span> <span class="p">[]</span>
    
    <span class="c"># Get the column names and data types from the table</span>
    <span class="n">columns</span><span class="p">,</span> <span class="n">types</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;PRAGMA table_info({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">))</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>

    <span class="c"># Grab the column names from the first line of the input CSV file </span>
    <span class="n">data_columns</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c"># For each row, organize the data into the appropriate form for table insertion</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
      <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">]</span>
      <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="n">columns</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">col</span><span class="p">)]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">data_columns</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">col</span><span class="p">)]</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data_columns</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="n">data_columns</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">col</span><span class="p">)]</span> <span class="k">else</span> <span class="bp">None</span>
      <span class="c"># values[0] = sorted(list(set(range(1,self.list(&quot;SELECT max(id) FROM {}&quot;.format(table)).fetchone()[0]+2))-set(zip(*self.list(&quot;SELECT id FROM {}&quot;.format(table)).fetchall())[0])))[0]</span>
      <span class="n">update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">values</span><span class="p">))</span> <span class="k">if</span> <span class="n">values</span><span class="p">[</span><span class="n">columns</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)]</span> <span class="k">else</span> <span class="n">insert</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>

    <span class="c"># If they are unique records (i.e. don&#39;t have an &#39;id&#39; column value specified in the CSV file), add them as new records</span>
    <span class="k">if</span> <span class="n">insert</span><span class="p">:</span>
      <span class="n">u</span><span class="o">.</span><span class="n">printer</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">insert</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">empties</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">insert</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;INSERT INTO {} VALUES({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;?&#39;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">))),</span> <span class="n">i</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">modify</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="k">print</span> <span class="s">&quot;{} new records added to the {} table.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">insert</span><span class="p">),</span><span class="n">table</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>

    <span class="c"># If they do have a specified &#39;id&#39;, update the fields for that record with the supplied information</span>
    <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
      <span class="n">u</span><span class="o">.</span><span class="n">printer</span><span class="p">([</span><span class="s">&#39;Command&#39;</span><span class="p">,</span><span class="s">&#39;Result&#39;</span><span class="p">],[[</span><span class="s">&#39;-&#39;</span><span class="o">*</span><span class="mi">30</span><span class="p">,</span><span class="s">&#39;-&#39;</span><span class="o">*</span><span class="mi">100</span><span class="p">],[</span><span class="s">&#39;[column name]&#39;</span><span class="p">,</span><span class="s">&#39;Display full record entry for that column without taking action&#39;</span><span class="p">],[</span><span class="s">&#39;k&#39;</span><span class="p">,</span><span class="s">&#39;Keeps both records and assigns second one new id if necessary&#39;</span><span class="p">],[</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="s">&#39;Replaces all columns of first record with second record values&#39;</span><span class="p">],[</span><span class="s">&#39;r [column name] [column name]...&#39;</span><span class="p">,</span><span class="s">&#39;Replaces specified columns of first record with second record values&#39;</span><span class="p">],[</span><span class="s">&#39;c&#39;</span><span class="p">,</span><span class="s">&#39;Complete empty columns of first record with second record values where possible&#39;</span><span class="p">],[</span><span class="s">&#39;[Enter]&#39;</span><span class="p">,</span><span class="s">&#39;Keep first record and delete second&#39;</span><span class="p">],[</span><span class="s">&#39;abort&#39;</span><span class="p">,</span><span class="s">&#39;Abort merge of current table, undo all changes, and proceed to next table&#39;</span><span class="p">]],</span> <span class="n">title</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">update</span><span class="p">:</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;SELECT * FROM {} WHERE id={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="n">columns</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)]))</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">record</span><span class="p">:</span> <span class="n">compare_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
    <span class="c"># self.clean_up(table)</span>
   </div>
<div class="viewcode-block" id="get_db.add_ascii"><a class="viewcode-back" href="../../BDNYCdb.html#BDNYCdb.BDdb.get_db.add_ascii">[docs]</a>  <span class="k">def</span> <span class="nf">add_ascii</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asciiPath</span><span class="p">,</span> <span class="n">source_id</span><span class="p">,</span> <span class="n">header_chars</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;#&#39;</span><span class="p">],</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">snrPath</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">headerPath</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">wavelength_units</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">flux_units</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">publication_id</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">obs_date</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">wavelength_order</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">instrument_id</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">telescope_id</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">mode_id</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">regime</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">airmass</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span> 
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds an ascii spectrum to the *spectra* table given an **asciiPath**. Any *spectra* table columns besides *wavelength*, *flux*, *unc*, *snr* arrays can be specified as arguments.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    </span>
<span class="sd">    asciiPath: str</span>
<span class="sd">      The path to the ascii file with the wavelength, flux and (optional) uncertainty data</span>
<span class="sd">    source_id: int</span>
<span class="sd">      The id from the SOURCES table of the object to which the spectrum will be associated.</span>
<span class="sd">    header_chars: list</span>
<span class="sd">      If a line begins with any character in this list, that text will be used to generate a FITS header for the spectrum.</span>
<span class="sd">    start: int</span>
<span class="sd">      The index of the line after the last header line that begins the data to be saved.</span>
<span class="sd">    snrPath: str (optional)</span>
<span class="sd">      The path to the separate ascii file with the signal to noise values. Must be the same length as the wavelength and flux columns in the asciiPath file.</span>
<span class="sd">    headerPath: str (optional)</span>
<span class="sd">      The path to the FITS file that contains the header information to be stored with the spectrum.</span>
<span class="sd">    wavelength_units: str (optional)</span>
<span class="sd">      The wavelength units of the spectrum, e.g. &#39;um&#39;, &#39;A&#39;, &#39;nm&#39;</span>
<span class="sd">    flux_units: str (optional)</span>
<span class="sd">      The flux units of the spectrum, e.g. &#39;erg/s/cm2/A&#39;, &#39;W m-2 um-1&#39;</span>
<span class="sd">    publication_id: int (optional)</span>
<span class="sd">      The id from the PUBLICATIONS table that indicates the reference for the spectrum</span>
<span class="sd">    obs_date: str (optional)</span>
<span class="sd">      The date of the observation</span>
<span class="sd">    wavelength_order: int (optional)</span>
<span class="sd">      For high resolution spectra, the order of the observation, e.g. &#39;65&#39; for NIRSPEC order 65. Leave blank for low and medium resolution spectra.</span>
<span class="sd">    instrument_id: int (optional)</span>
<span class="sd">      The id from the INSTRUMENTS table used to take the spectrum</span>
<span class="sd">    telescope_id: int (optional)</span>
<span class="sd">      The id from the TELESCOPES table used to take the spectrum</span>
<span class="sd">    mode_id: int (optional)</span>
<span class="sd">      The id from the MODES table used to take the spectrum, if applicable</span>
<span class="sd">    regime: str (optional)</span>
<span class="sd">      The regime of the spectrum, e.g. &#39;OPT&#39;,&#39;NIR&#39; or &#39;MIR&#39;</span>
<span class="sd">    airmass: float (optional)</span>
<span class="sd">      The airmass at the time of observation</span>
<span class="sd">    comment: str (optional)</span>
<span class="sd">      Any comments about the spectrum that might be useful to future users.    </span>
<span class="sd">      </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filename</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">asciiPath</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">asciiPath</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="c"># Pull the data columns from the ascii file and snr file if applicable</span>
    <span class="n">wavelength</span><span class="p">,</span> <span class="n">flux</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&#39;float32&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data</span><span class="p">][</span><span class="n">start</span><span class="p">:</span><span class="n">start</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">snr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">snrPath</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&#39;float32&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">snrPath</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>
      <span class="n">unc</span> <span class="o">=</span> <span class="n">flx</span><span class="o">/</span><span class="n">snr</span> <span class="k">if</span> <span class="n">snrPath</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&#39;float32&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span> <span class="n">snr</span> <span class="o">=</span> <span class="n">unc</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="c"># Pull comments out of text file (lines which begin with one of the specified *header_chars*) and create FITS header for database insertion</span>
    <span class="k">if</span> <span class="n">headerPath</span><span class="p">:</span>
      <span class="n">header</span> <span class="o">=</span> <span class="n">clean_header</span><span class="p">(</span><span class="n">headerPath</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">h</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">asciiPath</span><span class="p">)</span> <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">char</span><span class="p">)</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">header_chars</span><span class="p">])]</span>
      <span class="k">if</span> <span class="n">h</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">h</span><span class="p">:</span> <span class="n">header</span><span class="p">[</span><span class="s">&#39;COMMENT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span><span class="o">.</span><span class="n">header</span>
      <span class="k">else</span><span class="p">:</span> <span class="n">header</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">regime</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">wavelength</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">500</span> <span class="ow">or</span> <span class="n">wavelength_units</span><span class="o">==</span><span class="s">&#39;um&#39;</span><span class="p">:</span> <span class="n">regime</span> <span class="o">=</span> <span class="s">&#39;OPT&#39;</span> <span class="k">if</span> <span class="n">wavelength</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">0.4</span> <span class="ow">and</span> <span class="n">wavelength</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">1.2</span> <span class="k">else</span> <span class="s">&#39;MIR&#39;</span> <span class="k">if</span> <span class="n">wavelength</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">2.5</span> <span class="k">else</span> <span class="s">&#39;NIR&#39;</span>     
    <span class="k">else</span><span class="p">:</span> <span class="n">regime</span> <span class="o">=</span> <span class="s">&#39;OPT&#39;</span> <span class="k">if</span> <span class="n">wavelength</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">4000</span> <span class="ow">and</span> <span class="n">wavelength</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">12000</span> <span class="k">else</span> <span class="s">&#39;MIR&#39;</span> <span class="k">if</span> <span class="n">wavelength</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">25000</span> <span class="k">else</span> <span class="s">&#39;NIR&#39;</span>
        
    <span class="c"># Insert spectrum into database</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="c"># Get the lowest spec_id from the spectra table</span>
      <span class="n">spec_id</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;SELECT max(id) FROM spectra&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;SELECT id FROM spectra&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())[</span><span class="mi">0</span><span class="p">])))[</span><span class="mi">0</span><span class="p">]</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;INSERT INTO spectra VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">spec_id</span><span class="p">,</span> <span class="n">source_id</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">wavelength_units</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">flux_units</span><span class="p">,</span> <span class="n">unc</span><span class="p">,</span> <span class="n">snr</span><span class="p">,</span> <span class="n">wavelength_order</span><span class="p">,</span> <span class="n">regime</span><span class="p">,</span> <span class="n">publication_id</span><span class="p">,</span> <span class="n">obs_date</span><span class="p">,</span> <span class="n">instrument_id</span><span class="p">,</span> <span class="n">telescope_id</span><span class="p">,</span> <span class="n">mode_id</span><span class="p">,</span> <span class="n">airmass</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="n">header</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">modify</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="n">u</span><span class="o">.</span><span class="n">printer</span><span class="p">([</span><span class="s">&#39;spec_id&#39;</span><span class="p">,</span><span class="s">&#39;source_id&#39;</span><span class="p">,</span><span class="s">&#39;wavelength_unit&#39;</span><span class="p">,</span><span class="s">&#39;flux_unit&#39;</span><span class="p">,</span><span class="s">&#39;regime&#39;</span><span class="p">,</span><span class="s">&#39;publication_id&#39;</span><span class="p">,</span><span class="s">&#39;obs_date&#39;</span><span class="p">,</span> <span class="s">&#39;instrument_id&#39;</span><span class="p">,</span> <span class="s">&#39;telescope_id&#39;</span><span class="p">,</span> <span class="s">&#39;mode_id&#39;</span><span class="p">,</span> <span class="s">&#39;airmass&#39;</span><span class="p">,</span> <span class="s">&#39;filename&#39;</span><span class="p">,</span> <span class="s">&#39;comment&#39;</span><span class="p">],[[</span><span class="n">spec_id</span><span class="p">,</span><span class="n">source_id</span><span class="p">,</span> <span class="n">wavelength_units</span><span class="p">,</span> <span class="n">flux_units</span><span class="p">,</span> <span class="n">regime</span><span class="p">,</span> <span class="n">publication_id</span><span class="p">,</span> <span class="n">obs_date</span><span class="p">,</span> <span class="n">instrument_id</span><span class="p">,</span> <span class="n">telescope_id</span><span class="p">,</span> <span class="n">mode_id</span><span class="p">,</span> <span class="n">airmass</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">comment</span><span class="p">]],</span> <span class="n">empties</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
      <span class="c"># self.clean_up(&#39;spectra&#39;)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span> 
      <span class="k">print</span> <span class="s">&quot;Couldn&#39;t add spectrum to database.&quot;</span>
 </div>
<div class="viewcode-block" id="get_db.add_numpy"><a class="viewcode-back" href="../../BDNYCdb.html#BDNYCdb.BDdb.get_db.add_numpy">[docs]</a>  <span class="k">def</span> <span class="nf">add_numpy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wav</span><span class="p">,</span> <span class="n">flx</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">snr</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">source_id</span><span class="p">,</span> <span class="n">wavelength_units</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">flux_units</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">publication_id</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">obs_date</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">wavelength_order</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">regime</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">instrument_id</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">telescope_id</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">mode_id</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">airmass</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">headerPath</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">wlog</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">SDSS</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generic function to insert spectra formatted as numpy arrays. Useful if the .fits file format is unusual (for instance, Magellan II Clay MIKE data) and needs to be extracted in some custom way.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    wav: array</span>
<span class="sd">      The Numpy wavelength array</span>
<span class="sd">    flx: array</span>
<span class="sd">      The Numpy flux array</span>
<span class="sd">    err: array</span>
<span class="sd">      The Numpy uncertainty array</span>
<span class="sd">    snr: array</span>
<span class="sd">      The Numpy signal to noise array</span>
<span class="sd">    filename: str</span>
<span class="sd">      The filename from which the data was taken</span>
<span class="sd">    source_id: int</span>
<span class="sd">      The id from the SOURCES table of the object to which the spectrum will be associated.</span>
<span class="sd">    wavelength_units: str (optional)</span>
<span class="sd">      The wavelength units of the spectrum, e.g. &#39;um&#39;, &#39;A&#39;, &#39;nm&#39;</span>
<span class="sd">    flux_units: str (optional)</span>
<span class="sd">      The flux units of the spectrum, e.g. &#39;erg/s/cm2/A&#39;, &#39;W m-2 um-1&#39;</span>
<span class="sd">    publication_id: int (optional)</span>
<span class="sd">      The id from the PUBLICATIONS table that indicates the reference for the spectrum</span>
<span class="sd">    obs_date: str (optional)</span>
<span class="sd">      The date of the observation</span>
<span class="sd">    wavelength_order: int (optional)</span>
<span class="sd">      For high resolution spectra, the order of the observation, e.g. &#39;65&#39; for NIRSPEC order 65. Leave blank for low and medium resolution spectra.</span>
<span class="sd">    instrument_id: int (optional)</span>
<span class="sd">      The id from the INSTRUMENTS table used to take the spectrum</span>
<span class="sd">    telescope_id: int (optional)</span>
<span class="sd">      The id from the TELESCOPES table used to take the spectrum</span>
<span class="sd">    mode_id: int (optional)</span>
<span class="sd">      The id from the MODES table used to take the spectrum, if applicable</span>
<span class="sd">    regime: str (optional)</span>
<span class="sd">      The regime of the spectrum, e.g. &#39;OPT&#39;,&#39;NIR&#39; or &#39;MIR&#39;</span>
<span class="sd">    airmass: float (optional)</span>
<span class="sd">      The airmass at the time of observation</span>
<span class="sd">    comment: str (optional)</span>
<span class="sd">      Any comments about the spectrum that might be useful to future users.    </span>
<span class="sd">      </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="k">if</span> <span class="s">&#39;microns&#39;</span> <span class="ow">in</span> <span class="n">wavelength_units</span> <span class="ow">or</span> <span class="s">&#39;Microns&#39;</span> <span class="ow">in</span> <span class="n">wavelength_units</span> <span class="ow">or</span> <span class="s">&#39;um&#39;</span> <span class="ow">in</span> <span class="n">wavelength_units</span><span class="p">:</span> 
        <span class="n">wavelength_units</span> <span class="o">=</span> <span class="s">&#39;um&#39;</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> 
      <span class="n">wavelength_units</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">flux_units</span><span class="o">=</span><span class="n">flux_units</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
      <span class="n">flux_units</span><span class="o">=</span><span class="s">&#39;&#39;</span>
    <span class="k">if</span> <span class="s">&#39;erg&#39;</span> <span class="ow">in</span> <span class="n">flux_units</span> <span class="ow">and</span> <span class="s">&#39;A&#39;</span> <span class="ow">in</span> <span class="n">flux_units</span><span class="p">:</span> <span class="n">flux_units</span> <span class="o">=</span> <span class="s">&#39;ergs-1cm-2A-1&#39;</span> <span class="k">if</span> <span class="s">&#39;erg&#39;</span> <span class="ow">in</span> <span class="n">flux_units</span> <span class="ow">and</span> <span class="s">&#39;A&#39;</span> <span class="ow">in</span> <span class="n">flux_units</span> <span class="k">else</span> <span class="s">&#39;ergs-1cm-2um-1&#39;</span> <span class="k">if</span> <span class="s">&#39;erg&#39;</span> <span class="ow">in</span> <span class="n">flux_units</span> <span class="ow">and</span> <span class="s">&#39;um&#39;</span> <span class="ow">in</span> <span class="n">flux_units</span> <span class="k">else</span> <span class="s">&#39;Wm-2um-1&#39;</span> <span class="k">if</span> <span class="s">&#39;W&#39;</span> <span class="ow">in</span> <span class="n">flux_units</span> <span class="ow">and</span> <span class="s">&#39;um&#39;</span> <span class="ow">in</span> <span class="n">flux_units</span> <span class="k">else</span> <span class="s">&#39;Wm-2A-1&#39;</span> <span class="k">if</span> <span class="s">&#39;W&#39;</span> <span class="ow">in</span> <span class="n">flux_units</span> <span class="ow">and</span> <span class="s">&#39;A&#39;</span> <span class="ow">in</span> <span class="n">flux_units</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">telescope_id</span> <span class="o">=</span> <span class="n">telescope_id</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
      <span class="n">telescope_id</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">instrument_id</span> <span class="o">=</span> <span class="n">instrument_id</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> 
      <span class="n">instrument_id</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">wavelength_order</span> <span class="o">=</span> <span class="n">wavelength_order</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> 
      <span class="n">instrument_id</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">mode_id</span> <span class="o">=</span> <span class="n">mode_id</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> 
      <span class="n">mode_id</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">airmass</span> <span class="o">=</span> <span class="n">airmass</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
      <span class="n">airmass</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">regime</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">wav</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">500</span> <span class="ow">or</span> <span class="n">wavelength_units</span><span class="o">==</span><span class="s">&#39;um&#39;</span><span class="p">:</span> <span class="n">regime</span> <span class="o">=</span> <span class="s">&#39;OPT&#39;</span> <span class="k">if</span> <span class="n">wav</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">0.4</span> <span class="ow">and</span> <span class="n">wav</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">1.2</span> <span class="k">else</span> <span class="s">&#39;MIR&#39;</span> <span class="k">if</span> <span class="n">wav</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">2.5</span> <span class="k">else</span> <span class="s">&#39;NIR&#39;</span>    
    <span class="k">else</span><span class="p">:</span> <span class="n">regime</span> <span class="o">=</span> <span class="s">&#39;OPT&#39;</span> <span class="k">if</span> <span class="n">wav</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">4000</span> <span class="ow">and</span> <span class="n">wav</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">12000</span> <span class="k">else</span> <span class="s">&#39;MIR&#39;</span> <span class="k">if</span> <span class="n">wav</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">25000</span> <span class="k">else</span> <span class="s">&#39;NIR&#39;</span>

    <span class="c"># Pull comments out of text file (lines which begin with one of the specified *header_chars*) and create FITS header for database insertion</span>
    <span class="k">if</span> <span class="n">headerPath</span><span class="p">:</span>
      <span class="n">header</span> <span class="o">=</span> <span class="n">clean_header</span><span class="p">(</span><span class="n">headerPath</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">header</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">spec_id</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;SELECT max(id) FROM spectra&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;SELECT id FROM spectra&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())[</span><span class="mi">0</span><span class="p">])))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;INSERT INTO spectra VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">spec_id</span><span class="p">,</span> <span class="n">source_id</span><span class="p">,</span> <span class="n">wav</span><span class="p">,</span> <span class="n">wavelength_units</span><span class="p">,</span> <span class="n">flx</span><span class="p">,</span> <span class="n">flux_units</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">snr</span><span class="p">,</span> <span class="n">wavelength_order</span><span class="p">,</span> <span class="n">regime</span><span class="p">,</span> <span class="n">publication_id</span><span class="p">,</span> <span class="n">obs_date</span><span class="p">,</span> <span class="n">instrument_id</span><span class="p">,</span> <span class="n">telescope_id</span><span class="p">,</span> <span class="n">mode_id</span><span class="p">,</span> <span class="n">airmass</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="n">header</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">modify</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">u</span><span class="o">.</span><span class="n">printer</span><span class="p">([</span><span class="s">&#39;spec_id&#39;</span><span class="p">,</span><span class="s">&#39;source_id&#39;</span><span class="p">,</span><span class="s">&#39;wavelength_unit&#39;</span><span class="p">,</span><span class="s">&#39;flux_unit&#39;</span><span class="p">,</span><span class="s">&#39;regime&#39;</span><span class="p">,</span><span class="s">&#39;publication_id&#39;</span><span class="p">,</span><span class="s">&#39;obs_date&#39;</span><span class="p">,</span> <span class="s">&#39;instrument_id&#39;</span><span class="p">,</span> <span class="s">&#39;telescope_id&#39;</span><span class="p">,</span> <span class="s">&#39;mode_id&#39;</span><span class="p">,</span> <span class="s">&#39;airmass&#39;</span><span class="p">,</span> <span class="s">&#39;filename&#39;</span><span class="p">,</span> <span class="s">&#39;comment&#39;</span><span class="p">],[[</span><span class="n">spec_id</span><span class="p">,</span><span class="n">source_id</span><span class="p">,</span> <span class="n">wavelength_units</span><span class="p">,</span> <span class="n">flux_units</span><span class="p">,</span> <span class="n">regime</span><span class="p">,</span> <span class="n">publication_id</span><span class="p">,</span> <span class="n">obs_date</span><span class="p">,</span> <span class="n">instrument_id</span><span class="p">,</span> <span class="n">telescope_id</span><span class="p">,</span> <span class="n">mode_id</span><span class="p">,</span> <span class="n">airmass</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">comment</span><span class="p">]],</span> <span class="n">empties</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="get_db.add_fits"><a class="viewcode-back" href="../../BDNYCdb.html#BDNYCdb.BDdb.get_db.add_fits">[docs]</a>  <span class="k">def</span> <span class="nf">add_fits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fitsPath</span><span class="p">,</span> <span class="n">source_id</span><span class="p">,</span> <span class="n">unc_fitsPath</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">wavelength_units</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">flux_units</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">publication_id</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">obs_date</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">wavelength_order</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">regime</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">instrument_id</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">telescope_id</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">mode_id</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">airmass</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">wlog</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">SDSS</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks the header of the **fitsFile** and inserts the data with **source_id**.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fitsPath: str</span>
<span class="sd">      The path to the FITS file with the wavelength, flux and (optional) uncertainty data</span>
<span class="sd">    source_id: int</span>
<span class="sd">      The id from the SOURCES table of the object to which the spectrum will be associated.</span>
<span class="sd">    unc_fitsPath: str</span>
<span class="sd">      The path to the separate FITS file with the uncertainty values. Must be the same length as the wavelength and flux arrays in the fitsPath file.</span>
<span class="sd">    wavelength_units: str (optional)</span>
<span class="sd">      The wavelength units of the spectrum, e.g. &#39;um&#39;, &#39;A&#39;, &#39;nm&#39;</span>
<span class="sd">    flux_units: str (optional)</span>
<span class="sd">      The flux units of the spectrum, e.g. &#39;erg/s/cm2/A&#39;, &#39;W m-2 um-1&#39;</span>
<span class="sd">    publication_id: int (optional)</span>
<span class="sd">      The id from the PUBLICATIONS table that indicates the reference for the spectrum</span>
<span class="sd">    obs_date: str (optional)</span>
<span class="sd">      The date of the observation</span>
<span class="sd">    wavelength_order: int (optional)</span>
<span class="sd">      For high resolution spectra, the order of the observation, e.g. &#39;65&#39; for NIRSPEC order 65. Leave blank for low and medium resolution spectra.</span>
<span class="sd">    instrument_id: int (optional)</span>
<span class="sd">      The id from the INSTRUMENTS table used to take the spectrum</span>
<span class="sd">    telescope_id: int (optional)</span>
<span class="sd">      The id from the TELESCOPES table used to take the spectrum</span>
<span class="sd">    mode_id: int (optional)</span>
<span class="sd">      The id from the MODES table used to take the spectrum, if applicable</span>
<span class="sd">    regime: str (optional)</span>
<span class="sd">      The regime of the spectrum, e.g. &#39;OPT&#39;,&#39;NIR&#39; or &#39;MIR&#39;</span>
<span class="sd">    airmass: float (optional)</span>
<span class="sd">      The airmass at the time of observation</span>
<span class="sd">    comment: str (optional)</span>
<span class="sd">      Any comments about the spectrum that might be useful to future users.    </span>
<span class="sd">      </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filename</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fitsPath</span><span class="p">),</span> <span class="n">clean_header</span><span class="p">(</span><span class="n">fitsPath</span><span class="p">)</span>

    <span class="c"># x- and y-units</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">wavelength_units</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">wavelength_units</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s">&#39;XUNITS&#39;</span><span class="p">]</span> 
        <span class="k">if</span> <span class="s">&#39;microns&#39;</span> <span class="ow">in</span> <span class="n">wavelength_units</span> <span class="ow">or</span> <span class="s">&#39;Microns&#39;</span> <span class="ow">in</span> <span class="n">wavelength_units</span> <span class="ow">or</span> <span class="s">&#39;um&#39;</span> <span class="ow">in</span> <span class="n">wavelength_units</span><span class="p">:</span> <span class="n">wavelength_units</span> <span class="o">=</span> <span class="s">&#39;um&#39;</span>
      <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
           <span class="k">if</span> <span class="n">header</span><span class="p">[</span><span class="s">&#39;BUNIT&#39;</span><span class="p">]:</span> <span class="n">wavelength_units</span> <span class="o">=</span> <span class="s">&#39;um&#39;</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="n">wavelength_units</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">flux_units</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span> <span class="n">flux_units</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s">&#39;YUNITS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">flux_units</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s">&#39;BUNIT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="n">flux_units</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">if</span> <span class="s">&#39;erg&#39;</span> <span class="ow">in</span> <span class="n">flux_units</span> <span class="ow">and</span> <span class="s">&#39;A&#39;</span> <span class="ow">in</span> <span class="n">flux_units</span><span class="p">:</span> <span class="n">flux_units</span> <span class="o">=</span> <span class="s">&#39;ergs-1cm-2A-1&#39;</span> <span class="k">if</span> <span class="s">&#39;erg&#39;</span> <span class="ow">in</span> <span class="n">flux_units</span> <span class="ow">and</span> <span class="s">&#39;A&#39;</span> <span class="ow">in</span> <span class="n">flux_units</span> <span class="k">else</span> <span class="s">&#39;ergs-1cm-2um-1&#39;</span> <span class="k">if</span> <span class="s">&#39;erg&#39;</span> <span class="ow">in</span> <span class="n">flux_units</span> <span class="ow">and</span> <span class="s">&#39;um&#39;</span> <span class="ow">in</span> <span class="n">flux_units</span> <span class="k">else</span> <span class="s">&#39;Wm-2um-1&#39;</span> <span class="k">if</span> <span class="s">&#39;W&#39;</span> <span class="ow">in</span> <span class="n">flux_units</span> <span class="ow">and</span> <span class="s">&#39;um&#39;</span> <span class="ow">in</span> <span class="n">flux_units</span> <span class="k">else</span> <span class="s">&#39;Wm-2A-1&#39;</span> <span class="k">if</span> <span class="s">&#39;W&#39;</span> <span class="ow">in</span> <span class="n">flux_units</span> <span class="ow">and</span> <span class="s">&#39;A&#39;</span> <span class="ow">in</span> <span class="n">flux_units</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>

    <span class="c"># Date, object name, telescope and instrument</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">obs_date</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span> <span class="n">obs_date</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s">&#39;DATE_OBS&#39;</span><span class="p">]</span>
      <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">obs_date</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s">&#39;DATE-OBS&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
          <span class="k">try</span><span class="p">:</span> <span class="n">obs_date</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s">&#39;DATE&#39;</span><span class="p">]</span>
          <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="n">obs_date</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">telescope_id</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s">&#39;TELESCOP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;TELESCOP&#39;</span><span class="p">],</span><span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>
        <span class="n">telescope_id</span> <span class="o">=</span> <span class="mi">5</span> <span class="k">if</span> <span class="s">&#39;hst&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="k">else</span> <span class="mi">6</span> <span class="k">if</span> <span class="s">&#39;spitzer&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="k">else</span> <span class="mi">7</span> <span class="k">if</span> <span class="s">&#39;irtf&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="k">else</span> <span class="mi">9</span> <span class="k">if</span> <span class="s">&#39;keck&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="s">&#39;ii&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="k">else</span> <span class="mi">8</span> <span class="k">if</span> <span class="s">&#39;keck&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="s">&#39;i&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="k">else</span> <span class="mi">10</span> <span class="k">if</span> <span class="s">&#39;kp&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="s">&#39;4&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="k">else</span> <span class="mi">11</span> <span class="k">if</span> <span class="s">&#39;kp&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="s">&#39;2&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="k">else</span> <span class="mi">12</span> <span class="k">if</span> <span class="s">&#39;bok&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="k">else</span> <span class="mi">13</span> <span class="k">if</span> <span class="s">&#39;mmt&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="k">else</span> <span class="mi">14</span> <span class="k">if</span> <span class="s">&#39;ctio&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="s">&#39;1&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="k">else</span> <span class="mi">15</span> <span class="k">if</span> <span class="s">&#39;ctio&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="s">&#39;4&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="k">else</span> <span class="mi">16</span> <span class="k">if</span> <span class="s">&#39;gemini&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="s">&#39;north&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="k">else</span> <span class="mi">17</span> <span class="k">if</span> <span class="s">&#39;gemini&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="s">&#39;south&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="k">else</span> <span class="mi">18</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;vlt&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="s">&#39;U2&#39;</span> <span class="ow">in</span> <span class="n">n</span><span class="p">)</span> <span class="k">else</span> <span class="mi">19</span> <span class="k">if</span> <span class="s">&#39;3.5m&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="k">else</span> <span class="mi">20</span> <span class="k">if</span> <span class="s">&#39;subaru&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="k">else</span> <span class="mi">21</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;mag&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="s">&#39;ii&#39;</span> <span class="ow">in</span> <span class="n">n</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s">&#39;clay&#39;</span> <span class="ow">in</span> <span class="n">n</span><span class="p">)</span> <span class="k">else</span> <span class="mi">22</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;mag&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="s">&#39;i&#39;</span> <span class="ow">in</span> <span class="n">n</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s">&#39;baade&#39;</span> <span class="ow">in</span> <span class="n">n</span><span class="p">)</span> <span class="k">else</span> <span class="mi">23</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;eso&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="s">&#39;1m&#39;</span> <span class="ow">in</span> <span class="n">n</span><span class="p">)</span> <span class="k">else</span> <span class="mi">24</span> <span class="k">if</span> <span class="s">&#39;cfht&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="k">else</span> <span class="mi">25</span> <span class="k">if</span> <span class="s">&#39;ntt&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="k">else</span> <span class="mi">26</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;palomar&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="s">&#39;200-inch&#39;</span> <span class="ow">in</span> <span class="n">n</span><span class="p">)</span> <span class="k">else</span> <span class="mi">27</span> <span class="k">if</span> <span class="s">&#39;pan-starrs&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="k">else</span> <span class="mi">28</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;palomar&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="s">&#39;60-inch&#39;</span> <span class="ow">in</span> <span class="n">n</span><span class="p">)</span> <span class="k">else</span> <span class="mi">29</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;ctio&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="s">&#39;0.9m&#39;</span> <span class="ow">in</span> <span class="n">n</span><span class="p">)</span> <span class="k">else</span> <span class="mi">30</span> <span class="k">if</span> <span class="s">&#39;soar&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="k">else</span> <span class="mi">31</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;vlt&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="s">&#39;U3&#39;</span> <span class="ow">in</span> <span class="n">n</span><span class="p">)</span> <span class="k">else</span> <span class="mi">32</span> <span class="k">if</span> <span class="p">(</span><span class="s">&#39;vlt&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="s">&#39;U4&#39;</span> <span class="ow">in</span> <span class="n">n</span><span class="p">)</span> <span class="k">else</span> <span class="mi">33</span> <span class="k">if</span> <span class="s">&#39;gtc&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="k">else</span> <span class="bp">None</span>
      <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="n">telescope_id</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">instrument_id</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span> 
        <span class="n">i</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s">&#39;INSTRUME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">instrument_id</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="s">&#39;r-c spec&#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="ow">or</span> <span class="s">&#39;test&#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="ow">or</span> <span class="s">&#39;nod&#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="mi">2</span> <span class="k">if</span> <span class="s">&#39;gmos-n&#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="mi">3</span> <span class="k">if</span> <span class="s">&#39;gmos-s&#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="mi">4</span> <span class="k">if</span> <span class="s">&#39;fors&#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="mi">5</span> <span class="k">if</span> <span class="s">&#39;lris&#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="mi">6</span> <span class="k">if</span> <span class="s">&#39;spex&#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="mi">7</span> <span class="k">if</span> <span class="s">&#39;ldss3&#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="mi">8</span> <span class="k">if</span> <span class="s">&#39;focas&#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="mi">9</span> <span class="k">if</span> <span class="s">&#39;nirspec&#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="mi">10</span> <span class="k">if</span> <span class="s">&#39;irs&#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="mi">11</span> <span class="k">if</span> <span class="s">&#39;fire&#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="mi">12</span> <span class="k">if</span> <span class="s">&#39;mage&#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="mi">13</span> <span class="k">if</span> <span class="s">&#39;goldcam&#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="mi">14</span> <span class="k">if</span> <span class="s">&#39;sinfoni&#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="mi">15</span> <span class="k">if</span> <span class="s">&#39;osiris&#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="mi">16</span> <span class="k">if</span> <span class="s">&#39;triplespec&#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="mi">17</span> <span class="k">if</span> <span class="s">&#39;x-shooter&#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="mi">18</span> <span class="k">if</span> <span class="s">&#39;gnirs&#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="mi">19</span> <span class="k">if</span> <span class="s">&#39;wircam&#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="mi">20</span> <span class="k">if</span> <span class="s">&#39;cormass&#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="mi">21</span> <span class="k">if</span> <span class="s">&#39;isaac&#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="mi">22</span> <span class="k">if</span> <span class="s">&#39;irac&#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="mi">23</span> <span class="k">if</span> <span class="s">&#39;dis&#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="mi">24</span> <span class="k">if</span> <span class="s">&#39;susi2&#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="mi">25</span> <span class="k">if</span> <span class="s">&#39;ircs&#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="mi">26</span> <span class="k">if</span> <span class="s">&#39;nirc&#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="mi">29</span> <span class="k">if</span> <span class="s">&#39;stis&#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="mi">0</span>
      <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="n">instrument_id</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span> <span class="n">airmass</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s">&#39;AIRMASS&#39;</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span> <span class="n">airmass</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">try</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">SDSS</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fitsPath</span><span class="p">,</span> <span class="n">memmap</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">flx</span><span class="p">,</span> <span class="n">wav</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">)[:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">flx</span><span class="p">,</span> <span class="n">wav</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">wavelength_units</span><span class="p">,</span> <span class="n">flux_units</span> <span class="o">=</span> <span class="n">flx</span><span class="o">*</span><span class="mi">10</span><span class="o">**-</span><span class="mi">17</span><span class="p">,</span> <span class="mi">10</span><span class="o">**</span><span class="n">wav</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">err</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**-</span><span class="mi">17</span><span class="p">,</span> <span class="s">&#39;A&#39;</span><span class="p">,</span> <span class="s">&#39;ergs-1cm-2A-1&#39;</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">read_spec</span><span class="p">(</span><span class="n">fitsPath</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">atomicron</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">negtonan</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">wlog</span><span class="o">=</span><span class="n">wlog</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">wav</span><span class="p">,</span> <span class="n">flx</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">err</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">read_spec</span><span class="p">(</span><span class="n">unc_fitsPath</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">atomicron</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">negtonan</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">wlog</span><span class="o">=</span><span class="n">wlog</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">unc_fitsPath</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span> <span class="n">err</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
      <span class="k">try</span><span class="p">:</span> <span class="n">snr</span> <span class="o">=</span> <span class="n">flx</span><span class="o">/</span><span class="n">err</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">flx</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="k">else</span> <span class="bp">None</span>
      <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span><span class="ne">IndexError</span><span class="p">):</span> <span class="n">snr</span> <span class="o">=</span> <span class="bp">None</span>

      <span class="k">if</span> <span class="ow">not</span> <span class="n">regime</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">wav</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">500</span> <span class="ow">or</span> <span class="n">wavelength_units</span><span class="o">==</span><span class="s">&#39;um&#39;</span><span class="p">:</span> <span class="n">regime</span> <span class="o">=</span> <span class="s">&#39;OPT&#39;</span> <span class="k">if</span> <span class="n">wav</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">0.4</span> <span class="ow">and</span> <span class="n">wav</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">1.2</span> <span class="k">else</span> <span class="s">&#39;MIR&#39;</span> <span class="k">if</span> <span class="n">wav</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">2.5</span> <span class="k">else</span> <span class="s">&#39;NIR&#39;</span>     
        <span class="k">else</span><span class="p">:</span> <span class="n">regime</span> <span class="o">=</span> <span class="s">&#39;OPT&#39;</span> <span class="k">if</span> <span class="n">wav</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">4000</span> <span class="ow">and</span> <span class="n">wav</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">12000</span> <span class="k">else</span> <span class="s">&#39;MIR&#39;</span> <span class="k">if</span> <span class="n">wav</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">25000</span> <span class="k">else</span> <span class="s">&#39;NIR&#39;</span>

      <span class="n">spec_id</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;SELECT max(id) FROM spectra&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;SELECT id FROM spectra&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())[</span><span class="mi">0</span><span class="p">])))[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">try</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;INSERT INTO spectra VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">spec_id</span><span class="p">,</span> <span class="n">source_id</span><span class="p">,</span> <span class="n">wav</span><span class="p">,</span> <span class="n">wavelength_units</span><span class="p">,</span> <span class="n">flx</span><span class="p">,</span> <span class="n">flux_units</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">snr</span><span class="p">,</span> <span class="n">wavelength_order</span><span class="p">,</span> <span class="n">regime</span><span class="p">,</span> <span class="n">publication_id</span><span class="p">,</span> <span class="n">obs_date</span><span class="p">,</span> <span class="n">instrument_id</span><span class="p">,</span> <span class="n">telescope_id</span><span class="p">,</span> <span class="n">mode_id</span><span class="p">,</span> <span class="n">airmass</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="n">header</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">modify</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="k">except</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;INSERT INTO spectra VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">spec_id</span><span class="p">,</span> <span class="n">source_id</span><span class="p">,</span> <span class="n">wav</span><span class="p">,</span> <span class="n">wavelength_units</span><span class="p">,</span> <span class="n">flx</span><span class="p">,</span> <span class="n">flux_units</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">snr</span><span class="p">,</span> <span class="n">wavelength_order</span><span class="p">,</span> <span class="n">regime</span><span class="p">,</span> <span class="n">publication_id</span><span class="p">,</span> <span class="n">obs_date</span><span class="p">,</span> <span class="n">instrument_id</span><span class="p">,</span> <span class="n">telescope_id</span><span class="p">,</span> <span class="n">mode_id</span><span class="p">,</span> <span class="n">airmass</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="bp">None</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">modify</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="n">u</span><span class="o">.</span><span class="n">printer</span><span class="p">([</span><span class="s">&#39;spec_id&#39;</span><span class="p">,</span><span class="s">&#39;source_id&#39;</span><span class="p">,</span><span class="s">&#39;wavelength_unit&#39;</span><span class="p">,</span><span class="s">&#39;flux_unit&#39;</span><span class="p">,</span><span class="s">&#39;regime&#39;</span><span class="p">,</span><span class="s">&#39;publication_id&#39;</span><span class="p">,</span><span class="s">&#39;obs_date&#39;</span><span class="p">,</span> <span class="s">&#39;instrument_id&#39;</span><span class="p">,</span> <span class="s">&#39;telescope_id&#39;</span><span class="p">,</span> <span class="s">&#39;mode_id&#39;</span><span class="p">,</span> <span class="s">&#39;airmass&#39;</span><span class="p">,</span> <span class="s">&#39;filename&#39;</span><span class="p">,</span> <span class="s">&#39;comment&#39;</span><span class="p">],[[</span><span class="n">spec_id</span><span class="p">,</span><span class="n">source_id</span><span class="p">,</span> <span class="n">wavelength_units</span><span class="p">,</span> <span class="n">flux_units</span><span class="p">,</span> <span class="n">regime</span><span class="p">,</span> <span class="n">publication_id</span><span class="p">,</span> <span class="n">obs_date</span><span class="p">,</span> <span class="n">instrument_id</span><span class="p">,</span> <span class="n">telescope_id</span><span class="p">,</span> <span class="n">mode_id</span><span class="p">,</span> <span class="n">airmass</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">comment</span><span class="p">]],</span> <span class="n">empties</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
      <span class="c"># self.clean_up(&#39;spectra&#39;)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;Couldn&#39;t add fits file {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fitsPath</span><span class="p">);</span> <span class="k">print</span> <span class="p">[</span><span class="n">filename</span><span class="p">,</span> <span class="n">source_id</span><span class="p">,</span> <span class="n">wavelength_units</span><span class="p">,</span> <span class="n">flux_units</span><span class="p">,</span> <span class="n">obs_date</span><span class="p">,</span> <span class="n">instrument_id</span><span class="p">,</span> <span class="n">telescope_id</span><span class="p">,</span> <span class="n">mode_id</span><span class="p">,</span> <span class="n">airmass</span><span class="p">,</span> <span class="n">comment</span><span class="p">]</span>
  </div>
<div class="viewcode-block" id="get_db.clean_up"><a class="viewcode-back" href="../../BDNYCdb.html#BDNYCdb.BDdb.get_db.clean_up">[docs]</a>  <span class="k">def</span> <span class="nf">clean_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Removes exact duplicates, blank records or data without a *source_id* from the specified **table**. Then finds possible duplicates and prompts for conflict resolution.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    table: str</span>
<span class="sd">      The name of the table to remove duplicates, blanks, and data without source attributions.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">types</span><span class="p">),</span> <span class="n">dup</span><span class="p">,</span> <span class="n">ignore</span><span class="p">,</span> <span class="n">I</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;PRAGMA table_info({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">))</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[],</span> <span class="s">&#39;&#39;</span>
    
    <span class="c"># Delete blank records, exact duplicates, or data without a source_id</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;DELETE FROM {0} WHERE ({1})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s">&#39; IS NULL&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span> <span class="k">else</span> <span class="p">(</span><span class="s">&#39; IS NULL AND &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">+</span><span class="s">&#39; IS NULL&#39;</span><span class="p">)))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;DELETE FROM {0} WHERE id NOT IN (SELECT min(id) FROM {0} GROUP BY {1})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))),</span> <span class="bp">self</span><span class="o">.</span><span class="n">modify</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">if</span> <span class="s">&#39;source_id&#39;</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;DELETE FROM {0} WHERE source_id IS NULL OR source_id IN (&#39;null&#39;,&#39;None&#39;,&#39;&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">table</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;sources&#39;</span><span class="p">,</span><span class="s">&#39;spectra&#39;</span><span class="p">,</span><span class="s">&#39;photometry&#39;</span><span class="p">,</span><span class="s">&#39;spectral_types&#39;</span><span class="p">,</span><span class="s">&#39;radial_velocities&#39;</span><span class="p">,</span><span class="s">&#39;parallaxes&#39;</span><span class="p">,</span><span class="s">&#39;proper_motions&#39;</span><span class="p">]:</span>
      <span class="c"># Define columns to check for uniqueness</span>
      <span class="n">primary</span><span class="p">,</span> <span class="n">secondary</span><span class="p">,</span> <span class="n">ignore</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;flux&#39;</span><span class="p">,</span><span class="s">&#39;magnitude&#39;</span><span class="p">,</span><span class="s">&#39;parallax&#39;</span><span class="p">,</span><span class="s">&#39;spectral_type&#39;</span><span class="p">,</span><span class="s">&#39;proper_motion_ra&#39;</span><span class="p">,</span><span class="s">&#39;proper_motion_dec&#39;</span><span class="p">,</span><span class="s">&#39;radial_velocity&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s">&#39;band&#39;</span><span class="p">,</span><span class="s">&#39;regime&#39;</span><span class="p">],</span> <span class="p">[]</span>
      
      <span class="c"># Find non-unique records and run BDdb.compare_records()</span>
      <span class="k">while</span> <span class="n">dup</span><span class="p">:</span>
        <span class="c"># Check SOURCES table for records with similar RA and Dec but different ids that are not companions or system components.</span>
        <span class="k">if</span> <span class="n">table</span><span class="o">==</span><span class="s">&#39;sources&#39;</span><span class="p">:</span> <span class="n">dup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span>  <span class="s">&quot;SELECT t1.*, t2.* FROM sources t1 JOIN sources t2 WHERE t1.id!=t2.id </span><span class="se">\</span>
<span class="s">                                                        AND (t1.companions IS NULL OR (t1.companions IS NOT NULL AND t1.companions NOT LIKE &#39;%&#39; || CAST(t2.id AS TEXT) || &#39;%&#39;)) AND (t2.companions IS NULL OR (t2.companions IS NOT NULL AND t2.companions NOT LIKE &#39;%&#39; || CAST(t1.id AS TEXT) || &#39;%&#39;)) </span><span class="se">\</span>
<span class="s">                                                        AND (t1.components IS NULL OR (t1.components IS NOT NULL AND t1.components NOT LIKE &#39;%&#39; || CAST(t2.id AS TEXT) || &#39;%&#39;)) AND (t2.components IS NULL OR (t2.components IS NOT NULL AND t2.components NOT LIKE &#39;%&#39; || CAST(t1.id AS TEXT) || &#39;%&#39;)) </span><span class="se">\</span>
<span class="s">                                                        AND (t1.ra BETWEEN t2.ra-0.0007 AND t2.ra+0.0007) AND (t1.dec BETWEEN t2.dec-0.00077 AND t2.dec+0.0007)</span><span class="se">\</span>
<span class="s">                                                        {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39; AND &#39;</span><span class="o">+</span><span class="s">&#39; AND &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;(t1.id NOT IN ({0}) AND t2.id NOT IN ({0}))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">i</span><span class="p">)))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ignore</span><span class="p">])</span> <span class="k">if</span> <span class="n">ignore</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span> 

        <span class="c"># Check all other tables for records with identical primary and secondary column values but different ids.        </span>
        <span class="k">else</span><span class="p">:</span> <span class="n">dup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;SELECT t1.*, t2.* FROM {0} AS t1 JOIN {0} AS t2 ON t1.source_id=t2.source_id WHERE t1.id!=t2.id AND t1.{1}=t2.{1}{2}{3}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">primary</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(),</span> <span class="s">&#39; AND t1.{0}=t2.{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">secondary</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span> <span class="k">if</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">secondary</span><span class="p">]</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39; AND &#39;</span><span class="o">+</span><span class="s">&#39; AND &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;(t1.id NOT IN ({0}) AND t2.id NOT IN ({0}))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">i</span><span class="p">)))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ignore</span><span class="p">])</span> <span class="k">if</span> <span class="n">ignore</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>        
        
        <span class="c"># Compare potential duplicates and prompt user for action on each</span>
        <span class="k">if</span> <span class="n">dup</span> <span class="ow">and</span> <span class="n">dup</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">dup</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="n">dup</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">dup</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">:][</span><span class="mi">0</span><span class="p">]:</span>
          <span class="n">I</span> <span class="o">=</span> <span class="n">compare_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">dup</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">dup</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span> <span class="n">dup</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">dup</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">:],</span> <span class="n">delete</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
          <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span> <span class="n">ignore</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
          <span class="k">elif</span> <span class="n">I</span><span class="o">==</span><span class="s">&#39;undo&#39;</span><span class="p">:</span> <span class="k">pass</span> <span class="c"># Add this functionality!</span>
          <span class="k">elif</span> <span class="n">I</span><span class="o">==</span><span class="s">&#39;abort&#39;</span><span class="p">:</span> <span class="k">break</span>
          <span class="k">else</span><span class="p">:</span> <span class="k">pass</span>
    
    <span class="c"># Finish or abort table merge</span>
    <span class="k">if</span> <span class="n">I</span><span class="o">==</span><span class="s">&#39;abort&#39;</span><span class="p">:</span> 
      <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">Aborted merge of {} table. Undoing all changes.</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
      <span class="k">return</span> <span class="s">&#39;abort&#39;</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">print</span> <span class="s">&#39;Finished clean up on {} table.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="get_db.edit_columns"><a class="viewcode-back" href="../../BDNYCdb.html#BDNYCdb.BDdb.get_db.edit_columns">[docs]</a>  <span class="k">def</span> <span class="nf">edit_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">types</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rearrange, add or delete columns from database **table** with desired ordered list of **columns** and corresponding data **types**.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    table: str</span>
<span class="sd">      The name of the table to modify</span>
<span class="sd">    columns: list</span>
<span class="sd">      A list of the columns in the order in which they are to appear in the SQL table</span>
<span class="sd">    types: list</span>
<span class="sd">      A list of the types corresponding to each column in the columns list above.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;INTEGER PRIMARY KEY&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;ALTER TABLE {0} RENAME TO TempOldTable&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;CREATE TABLE {0} ({1})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;{} {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span><span class="n">types</span><span class="p">)]))),</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;INSERT INTO {0} ({1}) SELECT {1} FROM TempOldTable&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;PRAGMA table_info(TempOldTable)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">]))),</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;DROP TABLE TempOldTable&quot;</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="get_db.header"><a class="viewcode-back" href="../../BDNYCdb.html#BDNYCdb.BDdb.get_db.header">[docs]</a>  <span class="k">def</span> <span class="nf">header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrum_id_or_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prints the header information for the given **spectrum_id_or_path**.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spectrum_id_or_path: (int, str)</span>
<span class="sd">      The id from the SPECTRA table or the path to the FITS file of the spectrum header to print.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spectrum_id_or_path</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
      <span class="k">try</span><span class="p">:</span> 
        <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="s">&quot;SELECT * FROM spectra WHERE id={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spectrum_id_or_path</span><span class="p">))</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s">&#39;header&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">H</span><span class="p">:</span> <span class="k">return</span> <span class="n">H</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">print</span> <span class="s">&#39;No header for spectrum {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spectrum_id_or_path</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span> <span class="k">print</span> <span class="s">&#39;No spectrum with id {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spectrum_id_or_path</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">spectrum_id_or_path</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">spectrum_id_or_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.fits&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">clean_header</span><span class="p">(</span><span class="n">spectrum_id_or_path</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">txt</span><span class="p">,</span> <span class="n">H</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">spectrum_id_or_path</span><span class="p">),</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">txt</span><span class="p">:</span> 
          <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">):</span> <span class="n">H</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">txt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">H</span><span class="p">)</span> <span class="k">if</span> <span class="n">H</span> <span class="k">else</span> <span class="s">&#39;No header for spectrum {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spectrum_id_or_path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">print</span> <span class="s">&#39;No such file {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spectrum_id_or_path</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="get_db.identify"><a class="viewcode-back" href="../../BDNYCdb.html#BDNYCdb.BDdb.get_db.identify">[docs]</a>  <span class="k">def</span> <span class="nf">identify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">search</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For **search** input of (ra,dec) decimal degree tuple, i.e. &#39;(12.3456,-65.4321)&#39;, returns all sources within 1 arcminute.</span>
<span class="sd">    For **search** input of text string, i.e. &#39;vb10&#39;, returns all sources with case-insensitive partial text matches in *names* or *designation* columns.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    search: (str, tuple)</span>
<span class="sd">      The text or coordinate tuple to search the SOURCES table with.</span>
<span class="sd">      </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span> <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;SELECT id,ra,dec,designation,unum,shortname,names FROM sources WHERE ra BETWEEN &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">search</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.01667</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; AND &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">search</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">0.01667</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; AND dec BETWEEN &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">search</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mf">0.01667</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; AND &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">search</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">0.01667</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span> <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;SELECT id,ra,dec,designation,unum,shortname,components,companions,names FROM sources WHERE REPLACE(names,&#39; &#39;,&#39;&#39;) like &#39;%&quot;</span><span class="o">+</span><span class="n">search</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;%&#39; or designation like &#39;%&quot;</span><span class="o">+</span><span class="n">search</span><span class="o">+</span><span class="s">&quot;%&#39; or unum like &#39;%&quot;</span><span class="o">+</span><span class="n">search</span><span class="o">+</span><span class="s">&quot;%&#39; or shortname like &#39;%&quot;</span><span class="o">+</span><span class="n">search</span><span class="o">+</span><span class="s">&quot;%&#39;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">results</span><span class="p">:</span> 
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
      <span class="k">else</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">printer</span><span class="p">([</span><span class="s">&#39;id&#39;</span><span class="p">,</span><span class="s">&#39;ra&#39;</span><span class="p">,</span><span class="s">&#39;dec&#39;</span><span class="p">,</span><span class="s">&#39;designation&#39;</span><span class="p">,</span><span class="s">&#39;unum&#39;</span><span class="p">,</span><span class="s">&#39;short&#39;</span><span class="p">,</span><span class="s">&#39;components&#39;</span><span class="p">,</span><span class="s">&#39;companions&#39;</span><span class="p">,</span><span class="s">&#39;names&#39;</span><span class="p">],</span> <span class="n">results</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">empties</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;No objects found by {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">search</span><span class="p">)</span>
      </div>
<div class="viewcode-block" id="get_db.inventory"><a class="viewcode-back" href="../../BDNYCdb.html#BDNYCdb.BDdb.get_db.inventory">[docs]</a>  <span class="k">def</span> <span class="nf">inventory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ID</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prints a summary of all objects in the database. Input string or list of strings in **ID** or **unum** for specific objects.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ID: (int, list)</span>
<span class="sd">      The id or list of ids from the SOURCES table whose data across all tables is to be printed.</span>
<span class="sd">    verbose: bool</span>
<span class="sd">      Prints all data from all tables if True else prints a data summary.</span>
<span class="sd">    plot: bool</span>
<span class="sd">      Plots all spectra for the object.</span>
<span class="sd">    data: bool</span>
<span class="sd">      If ID is a list and data is True, returns the results of the SOURCES table search.</span>
<span class="sd">      </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">      If ID is a list and data is True, returns the results of the summary SQL query for all given source_id.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ID</span><span class="p">:</span>
      <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;SELECT sources.id, sources.unum, sources.designation, sources.ra, sources.dec, (SELECT COUNT(*) FROM spectra WHERE spectra.source_id=sources.id), (SELECT COUNT(*) FROM spectra WHERE spectra.source_id=sources.id AND spectra.regime=&#39;OPT&#39;), (SELECT COUNT(*) FROM spectra WHERE spectra.source_id=sources.id AND spectra.regime=&#39;NIR&#39;), (SELECT COUNT(*) FROM photometry WHERE photometry.source_id=sources.id), (SELECT parallax from parallaxes WHERE parallaxes.source_id=sources.id), (SELECT parallax_unc from parallaxes WHERE parallaxes.source_id=sources.id), (SELECT spectral_type FROM spectral_types WHERE spectral_types.source_id=sources.id AND regime=&#39;OPT&#39;), (SELECT spectral_type FROM spectral_types WHERE spectral_types.source_id=sources.id AND regime=&#39;IR&#39;), (SELECT gravity from spectral_types WHERE spectral_types.source_id=sources.id) FROM sources&quot;</span>
      <span class="n">IDS</span> <span class="o">=</span> <span class="n">ID</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">ID</span><span class="p">]</span>
      
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">IDS</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;sources&#39;</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;SELECT * FROM sqlite_master WHERE type=&#39;table&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">t</span><span class="o">!=</span><span class="s">&#39;sources&#39;</span><span class="p">]:</span>
          <span class="n">columns</span><span class="p">,</span> <span class="n">types</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;PRAGMA table_info({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">))</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
          <span class="k">if</span> <span class="s">&#39;source_id&#39;</span> <span class="ow">in</span> <span class="n">columns</span> <span class="ow">or</span> <span class="n">table</span><span class="o">==</span><span class="s">&#39;sources&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;SELECT * FROM {} WHERE {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="s">&#39;id={}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span> <span class="k">if</span> <span class="n">table</span><span class="o">==</span><span class="s">&#39;sources&#39;</span> <span class="k">else</span> <span class="s">&#39;source_id={}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ID</span><span class="p">)))</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="o">+</span><span class="p">[</span><span class="n">columns</span><span class="p">,</span><span class="n">types</span><span class="p">]:</span>
              <span class="k">if</span> <span class="n">table</span><span class="o">!=</span><span class="s">&#39;sources&#39;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
              <span class="k">if</span> <span class="n">table</span><span class="o">==</span><span class="s">&#39;spectra&#39;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">printer</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;wavelength_units&#39;</span><span class="p">,</span><span class="s">&#39;W&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;flux_units&#39;</span><span class="p">,</span><span class="s">&#39;F&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;comment&#39;</span><span class="p">,</span><span class="s">&#39;com&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;header&#39;</span><span class="p">,</span><span class="s">&#39;head&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;wavelength_order&#39;</span><span class="p">,</span><span class="s">&#39;ord&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;lication_id&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;rument_id&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;escope_id&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;mode_id&#39;</span><span class="p">,</span><span class="s">&#39;mode&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">],</span> <span class="p">[[</span><span class="s">&#39;Yes&#39;</span> <span class="k">if</span> <span class="n">t</span><span class="o">==</span><span class="s">&#39;HEADER&#39;</span> <span class="ow">or</span> <span class="n">c</span><span class="o">==</span><span class="s">&#39;comment&#39;</span> <span class="ow">and</span> <span class="n">v</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)[</span><span class="mi">2</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span> <span class="k">if</span> <span class="n">t</span><span class="o">==</span><span class="s">&#39;ARRAY&#39;</span> <span class="ow">and</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s">&#39;&#39;</span> <span class="k">else</span> <span class="n">v</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span><span class="n">types</span><span class="p">,</span><span class="n">d</span><span class="p">)]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span> <span class="k">if</span> <span class="n">table</span><span class="o">==</span><span class="s">&#39;spectra&#39;</span> <span class="k">else</span> <span class="n">data</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="mi">20</span> <span class="k">if</span> <span class="n">table</span><span class="o">==</span><span class="s">&#39;sources&#39;</span> <span class="k">else</span> <span class="mi">50</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">&#39;SOURCE: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span> <span class="k">if</span> <span class="n">table</span><span class="o">==</span><span class="s">&#39;sources&#39;</span> <span class="k">else</span> <span class="n">table</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">empties</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">q</span><span class="o">+</span><span class="s">&#39; WHERE id IN ({})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="o">+</span><span class="s">&quot;&#39;,&#39;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">IDS</span><span class="p">))</span><span class="o">+</span><span class="s">&quot;&#39;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
          <span class="k">if</span> <span class="n">D</span><span class="p">:</span>
            <span class="n">u</span><span class="o">.</span><span class="n">printer</span><span class="p">([</span><span class="s">&#39;id&#39;</span><span class="p">,</span><span class="s">&#39;unum&#39;</span><span class="p">,</span><span class="s">&#39;name&#39;</span><span class="p">,</span><span class="s">&#39;ra&#39;</span><span class="p">,</span><span class="s">&#39;dec&#39;</span><span class="p">,</span><span class="s">&#39;Spec Count&#39;</span><span class="p">,</span><span class="s">&#39;Optical&#39;</span><span class="p">,</span><span class="s">&#39;NIR&#39;</span><span class="p">,</span><span class="s">&#39;Phot Count&#39;</span><span class="p">,</span><span class="s">&#39;Pi&#39;</span><span class="p">,</span><span class="s">&#39;Pi_unc&#39;</span><span class="p">,</span><span class="s">&#39;OPT&#39;</span><span class="p">,</span><span class="s">&#39;IR&#39;</span><span class="p">,</span><span class="s">&#39;grav&#39;</span><span class="p">],</span> <span class="n">D</span><span class="p">,</span> <span class="n">empties</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span> <span class="k">return</span> <span class="n">D</span>
          <span class="k">else</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;No sources found{}.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39; with id &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span> <span class="k">if</span> <span class="n">ID</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span> <span class="k">pass</span>
      <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">I</span> <span class="ow">in</span> <span class="n">IDS</span><span class="p">:</span>
          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="s">&quot;SELECT * FROM spectra WHERE source_id={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">I</span><span class="p">))</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_spectrum</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="get_db.merge"><a class="viewcode-back" href="../../BDNYCdb.html#BDNYCdb.BDdb.get_db.merge">[docs]</a>  <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conflicted</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="p">[],</span> <span class="n">diff_only</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merges specific **tables** or all tables of **conflicted** databse into the master database.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    conflicted: str</span>
<span class="sd">      The path of the SQL database to be merged into the master.</span>
<span class="sd">    tables: list (optional)</span>
<span class="sd">      The list of tables to merge. If None, all tables are merged.</span>
<span class="sd">    diff_only: bool</span>
<span class="sd">      If True, only prints the differences of each table and doesn&#39;t actually merge anything.</span>
<span class="sd">      </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">conflicted</span><span class="p">):</span>
      <span class="c"># Load and attach master and conflicted databases</span>
      <span class="n">con</span><span class="p">,</span> <span class="n">master</span><span class="p">,</span> <span class="n">reassign</span> <span class="o">=</span> <span class="n">get_db</span><span class="p">(</span><span class="n">conflicted</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;PRAGMA database_list&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="p">{}</span>
      <span class="n">con</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;ATTACH DATABASE &#39;{}&#39; AS m&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">master</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;ATTACH DATABASE &#39;{}&#39; AS c&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">conflicted</span><span class="p">)),</span> <span class="n">con</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;ATTACH DATABASE &#39;{}&#39; AS c&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">conflicted</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;ATTACH DATABASE &#39;{}&#39; AS m&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">master</span><span class="p">))</span>
      
      <span class="c"># Drop any backup tables from failed merges</span>
      <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;DROP TABLE IF EXISTS Backup_{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">))</span>
      
      <span class="c"># Gather user data to add to CHANGELOG table</span>
      <span class="kn">import</span> <span class="nn">socket</span><span class="o">,</span> <span class="nn">datetime</span>
      <span class="n">user</span><span class="p">,</span> <span class="n">machine_name</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">modified_tables</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;Please enter your name : &#39;</span><span class="p">),</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">(),</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M&quot;</span><span class="p">),</span> <span class="p">[]</span>
      
      <span class="c"># Print instructions for user</span>
      <span class="n">u</span><span class="o">.</span><span class="n">printer</span><span class="p">([</span><span class="s">&#39;Command&#39;</span><span class="p">,</span><span class="s">&#39;Result&#39;</span><span class="p">],[[</span><span class="s">&#39;-&#39;</span><span class="o">*</span><span class="mi">30</span><span class="p">,</span><span class="s">&#39;-&#39;</span><span class="o">*</span><span class="mi">100</span><span class="p">],[</span><span class="s">&#39;[column name]&#39;</span><span class="p">,</span><span class="s">&#39;Display full record entry for that column without taking action&#39;</span><span class="p">],[</span><span class="s">&#39;k&#39;</span><span class="p">,</span><span class="s">&#39;Keeps both records and assigns second one new id if necessary&#39;</span><span class="p">],[</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="s">&#39;Replaces all columns of first record with second record values&#39;</span><span class="p">],[</span><span class="s">&#39;r [column name] [column name]...&#39;</span><span class="p">,</span><span class="s">&#39;Replaces specified columns of first record with second record values&#39;</span><span class="p">],[</span><span class="s">&#39;c&#39;</span><span class="p">,</span><span class="s">&#39;Complete empty columns of first record with second record values where possible&#39;</span><span class="p">],[</span><span class="s">&#39;[Enter]&#39;</span><span class="p">,</span><span class="s">&#39;Keep first record and delete second&#39;</span><span class="p">],[</span><span class="s">&#39;abort&#39;</span><span class="p">,</span><span class="s">&#39;Abort merge of current table, undo all changes, and proceed to next table&#39;</span><span class="p">]],</span> <span class="n">title</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">)</span>
      
      <span class="c"># Merge table by table, starting with SOURCES</span>
      <span class="n">tables</span> <span class="o">=</span> <span class="n">tables</span> <span class="ow">or</span> <span class="p">[</span><span class="s">&#39;sources&#39;</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;SELECT * FROM sqlite_master WHERE name NOT LIKE &#39;%Backup%&#39; AND type=&#39;table&#39;{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&quot; AND name IN ({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="o">+</span><span class="s">&quot;&#39;,&#39;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;&#39;&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">tables</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">t</span><span class="o">!=</span><span class="s">&#39;sources&#39;</span><span class="p">]</span>
      <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="c"># Get column names and data types from master table and column names from conflicted table</span>
        <span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">types</span><span class="p">),</span> <span class="n">conflicted_cols</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;PRAGMA table_info({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">))</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">con</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;PRAGMA table_info({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">))</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())[</span><span class="mi">1</span><span class="p">]</span>
                
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">conflicted_cols</span><span class="p">]):</span>
          <span class="c"># Abort table merge if conflicted has new columns not present in master. New columns must be added to the master database first via db.edit_columns().</span>
          <span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Merge of {0} table aborted since conflicted copy has columns {1} not present in master.</span><span class="se">\n</span><span class="s">Add new columns to master with BDdb.edit_columns() and try again.</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">upper</span><span class="p">(),[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">conflicted_cols</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">])</span>
        
        <span class="k">else</span><span class="p">:</span>
          <span class="c"># Add new columns from master table to conflicted table if necessary</span>
          <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">conflicted_cols</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">]):</span> <span class="n">con</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;DROP TABLE IF EXISTS Conflicted_{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">)),</span> <span class="n">con</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;ALTER TABLE {0} RENAME TO Conflicted_{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">)),</span> <span class="n">con</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;CREATE TABLE {0} ({1})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;{} {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span><span class="n">types</span><span class="p">)]))),</span> <span class="n">con</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;INSERT INTO {0} ({1}) SELECT {1} FROM Conflicted_{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">conflicted_cols</span><span class="p">))),</span> <span class="n">con</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;DROP TABLE Conflicted_{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">)),</span> <span class="n">con</span><span class="o">.</span><span class="n">modify</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        
          <span class="c"># Pull unique records from conflicted table</span>
          <span class="n">data</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">con</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;SELECT * FROM (SELECT 1 AS db, {0} FROM m.{2} UNION ALL SELECT 2 AS db, {0} FROM c.{2}) GROUP BY {1} HAVING COUNT(*)=1 AND db=2&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">columns</span><span class="p">),</span><span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span><span class="n">table</span><span class="p">))</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>

          <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">diff_only</span><span class="p">:</span>
              <span class="n">u</span><span class="o">.</span><span class="n">printer</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="p">[[</span><span class="nb">repr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">d</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">],</span> <span class="n">truncate</span><span class="o">=</span><span class="mi">15</span> <span class="k">if</span> <span class="n">table</span><span class="o">==</span><span class="s">&#39;spectra&#39;</span> <span class="k">else</span> <span class="mi">20</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
              <span class="c"># Make temporary table copy so changes can be undone at any time</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;DROP TABLE IF EXISTS Backup_{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;ALTER TABLE {0} RENAME TO Backup_{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;CREATE TABLE {0} ({1})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;{} {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span><span class="n">types</span><span class="p">)]))),</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;INSERT INTO {0} ({1}) SELECT {1} FROM Backup_{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">columns</span><span class="p">)))</span>

              <span class="c"># Create a dictionary of any reassigned ids from merged SOURCES tables and replace applicable source_ids in other tables.</span>
              <span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Merging {} tables.</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
              <span class="k">try</span><span class="p">:</span> <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;SELECT MAX(id) FROM {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">))</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
              <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
              <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">table</span><span class="o">==</span><span class="s">&#39;sources&#39;</span><span class="p">:</span> <span class="n">reassign</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">count</span>
                <span class="k">elif</span> <span class="s">&#39;source_id&#39;</span> <span class="ow">in</span> <span class="n">columns</span> <span class="ow">and</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">reassign</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">reassign</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span> <span class="k">pass</span>
                <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>
                <span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            
              <span class="c"># Insert unique conflicted records into master and run BDdb.clean_up()</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">listmany</span><span class="p">(</span><span class="s">&quot;INSERT INTO {} VALUES({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;?&#39;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">])),</span> <span class="n">data</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">modify</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
              <span class="k">print</span> <span class="s">&quot;{} records added to {} table at &#39;{}&#39;:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">table</span><span class="p">,</span> <span class="n">master</span><span class="p">)</span>
              <span class="n">u</span><span class="o">.</span><span class="n">printer</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="p">[[</span><span class="nb">repr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">d</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">],</span> <span class="n">truncate</span><span class="o">=</span><span class="mi">15</span> <span class="k">if</span> <span class="n">table</span><span class="o">==</span><span class="s">&#39;spectra&#39;</span> <span class="k">else</span> <span class="mi">20</span><span class="p">)</span>
              <span class="n">abort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_up</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
          
              <span class="c"># Undo all changes to table if merge is aborted. Otherwise, push table changes to master.</span>
              <span class="k">if</span> <span class="n">abort</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;DROP TABLE {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;ALTER TABLE Backup_{0} RENAME TO {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">modify</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
              <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;DROP TABLE Backup_{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">modify</span><span class="o">.</span><span class="n">commit</span><span class="p">(),</span> <span class="n">modified_tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
          
          <span class="k">else</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;{} tables identical.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
      
      <span class="c"># Add data to CHANGELOG table</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">diff_only</span><span class="p">:</span>
        <span class="n">user_description</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Please describe the changes made in this merge : &#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;INSERT INTO changelog VALUES(?, ?, ?, ?, ?, ?, ?)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">machine_name</span><span class="p">,</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">modified_tables</span><span class="p">),</span> <span class="n">user_description</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">conflicted</span><span class="p">))),</span> <span class="bp">self</span><span class="o">.</span><span class="n">modify</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      
      <span class="c"># Finish up and detach</span>
      <span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Merge complete!&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">diff_only</span> <span class="k">else</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Diff complete. No changes made to either database.&quot;</span>
      <span class="n">con</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;DETACH DATABASE c&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;DETACH DATABASE c&quot;</span><span class="p">),</span> <span class="n">con</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;DETACH DATABASE m&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;DETACH DATABASE m&quot;</span><span class="p">),</span> <span class="n">con</span><span class="o">.</span><span class="n">modify</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;File &#39;{}&#39; not found!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">conflicted</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="get_db.output_spectrum"><a class="viewcode-back" href="../../BDNYCdb.html#BDNYCdb.BDdb.get_db.output_spectrum">[docs]</a>  <span class="k">def</span> <span class="nf">output_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrum_id</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prints a file of the spectrum with id **spectrum_id** to an ascii file with specified **filepath**.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spectrum_id: int</span>
<span class="sd">      The id from the SPECTRA table of the spectrum to print to file.</span>
<span class="sd">    filepath: str</span>
<span class="sd">      The path of the file to print the data to.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="s">&quot;SELECT * FROM spectra WHERE id={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spectrum_id</span><span class="p">))</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
      <span class="kn">import</span> <span class="nn">csv</span>
      <span class="n">fn</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="s">&#39;{}{}.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;filename&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">spectrum_id</span><span class="p">),</span> <span class="nb">repr</span><span class="p">([</span><span class="nb">repr</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;header&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ascardlist</span><span class="p">()])</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;header&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="bp">None</span>
      <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;header&#39;</span><span class="p">]:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s">&#39;w&#39;</span> <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
          <span class="n">keys</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="n">coms</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">eval</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">eval</span><span class="p">(</span><span class="n">header</span><span class="p">)])</span>
          <span class="n">klen</span><span class="p">,</span> <span class="n">vlen</span><span class="p">,</span> <span class="n">clen</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nb">max</span><span class="p">([</span><span class="s">&#39;1&#39;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="n">j</span> <span class="k">else</span> <span class="s">&#39;0&#39;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="nb">bool</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">keys</span><span class="p">,</span><span class="n">vals</span><span class="p">,</span><span class="n">coms</span><span class="p">]]</span>
          <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span><span class="n">vals</span><span class="p">,</span><span class="n">coms</span><span class="p">):</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s">&#39;# {!s:{}}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">klen</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;= {!s:{}}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">vlen</span><span class="p">)</span><span class="o">+</span><span class="s">&#39; / {!s:{}}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">clen</span><span class="p">)])</span>
          <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s">&#39; &#39;</span><span class="p">])</span>
      <span class="n">u</span><span class="o">.</span><span class="n">dict2txt</span><span class="p">({</span><span class="nb">str</span><span class="p">(</span><span class="n">w</span><span class="p">):{</span><span class="s">&#39;flux [{}]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;flux_units&#39;</span><span class="p">]):</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="s">&#39;unc [{}]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;flux_units&#39;</span><span class="p">]):</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span> <span class="k">for</span> <span class="n">w</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;wavelength&#39;</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;flux&#39;</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;unc&#39;</span><span class="p">])},</span> <span class="n">fn</span><span class="p">,</span> <span class="n">column1</span><span class="o">=</span><span class="s">&#39;# wavelength [{}]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;wavelength_units&#39;</span><span class="p">]),</span> <span class="n">append</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;No spectrum found with id {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spectrum_id</span><span class="p">)</span>
  </div>
<div class="viewcode-block" id="get_db.plot_spectrum"><a class="viewcode-back" href="../../BDNYCdb.html#BDNYCdb.BDdb.get_db.plot_spectrum">[docs]</a>  <span class="k">def</span> <span class="nf">plot_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrum_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots spectrum **ID** from SPECTRA table.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spectrum_id: int</span>
<span class="sd">      The id from the SPECTRA table of the spectrum to plot.</span>
<span class="sd">      </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="s">&quot;SELECT * FROM spectra WHERE id={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spectrum_id</span><span class="p">))</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">i</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(),</span> <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s">&#39;text&#39;</span><span class="p">,</span> <span class="n">usetex</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span> <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s">&#39;wavelength&#39;</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="s">&#39;flux&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;spec_id: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])),</span> <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">),</span> <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s">&#39;log&#39;</span><span class="p">,</span> <span class="n">nonposy</span><span class="o">=</span><span class="s">&#39;clip&#39;</span><span class="p">),</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;source_id = {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s">&#39;source_id&#39;</span><span class="p">])),</span> <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span><span class="mf">0.15</span><span class="p">,</span><span class="mf">0.88</span><span class="p">,</span> <span class="s">&#39;{}</span><span class="se">\n</span><span class="s">{}</span><span class="se">\n</span><span class="s">{}</span><span class="se">\n</span><span class="s">{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s">&#39;filename&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;SELECT name FROM telescopes WHERE id={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s">&#39;telescope_id&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="s">&#39;telescope_id&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;SELECT name FROM instruments WHERE id={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s">&#39;instrument_id&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="s">&#39;instrument_id&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">[</span><span class="s">&#39;obs_date&#39;</span><span class="p">]),</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s">&#39;top&#39;</span><span class="p">),</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;[{}]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s">&#39;wavelength_units&#39;</span><span class="p">])),</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;[{}]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s">&#39;flux_units&#39;</span><span class="p">])),</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(),</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s">&#39;wavelength&#39;</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="s">&#39;flux&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">i</span><span class="p">[</span><span class="s">&#39;unc&#39;</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="s">&#39;flux&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">i</span><span class="p">[</span><span class="s">&#39;unc&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">),</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span> <span class="k">print</span> <span class="s">&#39;No uncertainty array for spectrum {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spectrum_id</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;Couldn&#39;t print spectrum {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spectrum_id</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">print</span> <span class="s">&quot;No spectrum {} in the SPECTRA table.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="get_db.lookup"><a class="viewcode-back" href="../../BDNYCdb.html#BDNYCdb.BDdb.get_db.lookup">[docs]</a>  <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">concatenate</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">delim</span><span class="o">=</span><span class="s">&#39;/&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Quickly look up records from the specified *table* and list *ids* to limit results. Specify column values to *concatenate* into a string.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    table: str</span>
<span class="sd">      The name of the table to perform a lookup on.</span>
<span class="sd">    ids: (int, list)</span>
<span class="sd">      An id or list of ids to lookup.</span>
<span class="sd">    concatenate: str</span>
<span class="sd">      The name of the column whose values should be joined by delim and returned.</span>
<span class="sd">    delim: str</span>
<span class="sd">      If concatenate, the delimiter to be used to join the results.</span>
<span class="sd">      </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    (list, str)</span>
<span class="sd">      A list of the complete record(s) or a concatenated string from the desired table with the given ids. </span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ids</span><span class="o">==</span><span class="s">&#39;-&#39;</span> <span class="ow">or</span> <span class="n">ids</span><span class="o">==</span><span class="p">[</span><span class="s">&#39;-&#39;</span><span class="p">]:</span> <span class="k">return</span> <span class="s">&#39;-&#39;</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="o">==</span><span class="nb">str</span> <span class="ow">and</span> <span class="n">table</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s">&#39;publications&#39;</span> <span class="ow">and</span> <span class="s">&#39;,&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;SELECT * FROM publications WHERE shortname LIKE &#39;%{0}%&#39; OR description LIKE &#39;%{0}%&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="o">==</span><span class="nb">int</span><span class="p">:</span> <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">ids</span><span class="p">]</span>
      <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="o">==</span><span class="nb">str</span> <span class="ow">and</span> <span class="s">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span> <span class="n">ids</span> <span class="o">=</span> <span class="n">ids</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="o">==</span><span class="nb">list</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span> <span class="n">ids</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
      <span class="k">try</span><span class="p">:</span> <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;SELECT {} FROM {} WHERE id IN ({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">concatenate</span> <span class="ow">or</span> <span class="s">&#39;*&#39;</span><span class="p">,</span><span class="n">table</span><span class="p">,</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">ids</span><span class="p">))))</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span> <span class="k">if</span> <span class="n">ids</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;SELECT * FROM {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">))</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
      <span class="k">except</span><span class="p">:</span> <span class="n">results</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
      <span class="k">return</span> <span class="s">&#39;&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span> <span class="k">else</span> <span class="n">delim</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span> <span class="k">if</span> <span class="n">concatenate</span> <span class="k">else</span> <span class="n">results</span>

<span class="c"># ==============================================================================================================================================</span>
<span class="c"># ================================= Adapters and converters for special data types =============================================================</span>
<span class="c"># ==============================================================================================================================================</span>
</div></div>
<div class="viewcode-block" id="adapt_array"><a class="viewcode-back" href="../../BDNYCdb.html#BDNYCdb.BDdb.adapt_array">[docs]</a><span class="k">def</span> <span class="nf">adapt_array</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Adapts a Numpy array into an ARRAY string to put into the database.</span>
<span class="sd">  </span>
<span class="sd">  Parameters</span>
<span class="sd">  ----------</span>
<span class="sd">  arr: array</span>
<span class="sd">    The Numpy array to be adapted into an ARRAY type that can be inserted into a SQL file.</span>
<span class="sd">    </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  ARRAY</span>
<span class="sd">    The adapted array object</span>
<span class="sd">    </span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">out</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
  <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">arr</span><span class="p">),</span> <span class="n">out</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="k">return</span> <span class="nb">buffer</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="adapt_header"><a class="viewcode-back" href="../../BDNYCdb.html#BDNYCdb.BDdb.adapt_header">[docs]</a><span class="k">def</span> <span class="nf">adapt_header</span><span class="p">(</span><span class="n">header</span><span class="p">):</span> 
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Adapts a FITS header into a HEADER string to put into the database.</span>
<span class="sd">  </span>
<span class="sd">  Parameters</span>
<span class="sd">  ----------</span>
<span class="sd">  header: fits.header</span>
<span class="sd">    The FITS header to be adapted into a HEADER type that can be inserted into a SQL file.</span>
<span class="sd">    </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  HEADER</span>
<span class="sd">    The adapted header object</span>
<span class="sd">    </span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">header</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="convert_array"><a class="viewcode-back" href="../../BDNYCdb.html#BDNYCdb.BDdb.convert_array">[docs]</a><span class="k">def</span> <span class="nf">convert_array</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Converts an ARRAY string stored in the database back into a Numpy array.</span>
<span class="sd">  </span>
<span class="sd">  Parameters</span>
<span class="sd">  ----------</span>
<span class="sd">  array: ARRAY</span>
<span class="sd">    The array object to be converted back into a Numpy array.</span>
<span class="sd">    </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  array</span>
<span class="sd">    The converted Numpy array.</span>
<span class="sd">    </span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">out</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
  <span class="n">out</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="convert_header"><a class="viewcode-back" href="../../BDNYCdb.html#BDNYCdb.BDdb.convert_header">[docs]</a><span class="k">def</span> <span class="nf">convert_header</span><span class="p">(</span><span class="n">header</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Converts a HEADER string stored in the database back into a FITS header.</span>
<span class="sd">  </span>
<span class="sd">  Parameters</span>
<span class="sd">  ----------</span>
<span class="sd">  header: HEADER</span>
<span class="sd">    The header object to be converted back into a FITS header.</span>
<span class="sd">    </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  fits.header</span>
<span class="sd">    The converted FITS header.</span>
<span class="sd">    </span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">pf</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">header</span> <span class="k">else</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="convert_spectrum"><a class="viewcode-back" href="../../BDNYCdb.html#BDNYCdb.BDdb.convert_spectrum">[docs]</a><span class="k">def</span> <span class="nf">convert_spectrum</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.fits&#39;</span><span class="p">):</span> 
    <span class="k">return</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">elif</span> <span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.txt&#39;</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">),</span> <span class="n">unpack</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">url</span>

<span class="c"># Register the adapters</span></div>
<span class="n">sql</span><span class="o">.</span><span class="n">register_adapter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">adapt_array</span><span class="p">),</span> <span class="n">sql</span><span class="o">.</span><span class="n">register_adapter</span><span class="p">(</span><span class="n">pf</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">Header</span><span class="p">,</span> <span class="n">adapt_header</span><span class="p">)</span>

<span class="c"># Register the converters</span>
<span class="n">sql</span><span class="o">.</span><span class="n">register_converter</span><span class="p">(</span><span class="s">&quot;ARRAY&quot;</span><span class="p">,</span> <span class="n">convert_array</span><span class="p">)</span>
<span class="n">sql</span><span class="o">.</span><span class="n">register_converter</span><span class="p">(</span><span class="s">&quot;HEADER&quot;</span><span class="p">,</span> <span class="n">convert_header</span><span class="p">)</span>
<span class="n">sql</span><span class="o">.</span><span class="n">register_converter</span><span class="p">(</span><span class="s">&quot;URL&quot;</span><span class="p">,</span> <span class="n">convert_spectrum</span><span class="p">)</span>

<span class="c"># ==============================================================================================================================================</span>
<span class="c"># ================================= Little helper functions ====================================================================================</span>
<span class="c"># ==============================================================================================================================================</span>

<div class="viewcode-block" id="clean_header"><a class="viewcode-back" href="../../BDNYCdb.html#BDNYCdb.BDdb.clean_header">[docs]</a><span class="k">def</span> <span class="nf">clean_header</span><span class="p">(</span><span class="n">fitsPath</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Clean illegal characters from keywords, insert END card, and rewrite header.</span>
<span class="sd">  </span>
<span class="sd">  Parameters</span>
<span class="sd">  ----------</span>
<span class="sd">  fitsPath: str</span>
<span class="sd">    The path of the FITS file to be repaired.</span>
<span class="sd">  </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  fits.header</span>
<span class="sd">    The FITS header with an END card inserted and illegal characters removed from keywords.</span>
<span class="sd">    </span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">header</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fitsPath</span><span class="p">,</span> <span class="n">ignore_missing_end</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
  <span class="n">new_header</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">cards</span><span class="p">:</span> <span class="n">new_header</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">pf</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">new_header</span><span class="p">)</span><span class="o">.</span><span class="n">header</span>
</div>
<div class="viewcode-block" id="compare_records"><a class="viewcode-back" href="../../BDNYCdb.html#BDNYCdb.BDdb.compare_records">[docs]</a><span class="k">def</span> <span class="nf">compare_records</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="s">&#39;c&#39;</span><span class="p">,</span><span class="s">&#39;k&#39;</span><span class="p">,</span><span class="s">&#39;sql&#39;</span><span class="p">],</span> <span class="n">delete</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Compares similar records and prompts the user to make decisions about keeping, updating, or modifying records in question.</span>
<span class="sd">  </span>
<span class="sd">  Parameters</span>
<span class="sd">  ----------</span>
<span class="sd">  table: str</span>
<span class="sd">    The name of the table whose records are being compared.</span>
<span class="sd">  columns: list</span>
<span class="sd">    The list of columns across which the comparison should be made.</span>
<span class="sd">  old: (str, int, float, blob)</span>
<span class="sd">    The value of the record with the lower id.</span>
<span class="sd">  new: (str, int, float, blob)</span>
<span class="sd">    The value of the record with the higher id.</span>
<span class="sd">  options: list</span>
<span class="sd">    The allowed options: &#39;r&#39; for replace, &#39;c&#39; for complete, &#39;k&#39; for keep, &#39;sql&#39; for raw SQL input.</span>
<span class="sd">  delete: bool</span>
<span class="sd">    Delete the record with the higher id.</span>
<span class="sd">    </span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">pold</span><span class="p">,</span> <span class="n">pnew</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;{:.3g}...{:.3g}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">old</span><span class="p">],</span> <span class="p">[</span><span class="s">&#39;{:.3g}...{:.3g}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">new</span><span class="p">]</span>
  <span class="n">u</span><span class="o">.</span><span class="n">printer</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="p">[</span><span class="n">pold</span><span class="p">,</span><span class="n">pnew</span><span class="p">],</span> <span class="n">truncate</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">empties</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">highlight</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">([[(</span><span class="n">i</span><span class="p">,</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span><span class="p">,(</span><span class="n">ov</span><span class="p">,</span><span class="n">nv</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">pold</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="n">pnew</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span> <span class="k">if</span> <span class="n">ov</span><span class="o">!=</span><span class="n">nv</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)])))</span>
  <span class="n">replace</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&quot;Keep both records [k]? Or replace [r], complete [c], or keep only [Press *Enter*] record {}? (Type column name to inspect or &#39;help&#39; for options): &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

  <span class="k">while</span> <span class="n">replace</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">columns</span> <span class="ow">or</span> <span class="n">replace</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s">&#39;help&#39;</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">replace</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">printer</span><span class="p">([</span><span class="s">&#39;id&#39;</span><span class="p">,</span><span class="n">replace</span><span class="o">.</span><span class="n">lower</span><span class="p">()],</span> <span class="p">[[</span><span class="n">i</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pold</span><span class="p">)</span> <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">columns</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">replace</span><span class="o">.</span><span class="n">lower</span><span class="p">())]],[</span><span class="n">i</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pnew</span><span class="p">)</span> <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">columns</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">replace</span><span class="o">.</span><span class="n">lower</span><span class="p">())]]],</span> <span class="n">empties</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>    
    <span class="k">elif</span> <span class="n">replace</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s">&#39;help&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">printer</span><span class="p">([</span><span class="s">&#39;Command&#39;</span><span class="p">,</span><span class="s">&#39;Result&#39;</span><span class="p">],[[</span><span class="s">&#39;-&#39;</span><span class="o">*</span><span class="mi">30</span><span class="p">,</span><span class="s">&#39;-&#39;</span><span class="o">*</span><span class="mi">100</span><span class="p">],[</span><span class="s">&#39;[column name]&#39;</span><span class="p">,</span><span class="s">&#39;Display full record entry for that column without taking action&#39;</span><span class="p">],[</span><span class="s">&#39;k&#39;</span><span class="p">,</span><span class="s">&#39;Keep both records and assign second one new id if necessary&#39;</span><span class="p">],[</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="s">&#39;Replace all columns of first record with second record values&#39;</span><span class="p">],[</span><span class="s">&#39;r [column name] [column name]...&#39;</span><span class="p">,</span><span class="s">&#39;Replace specified columns of first record with second record values&#39;</span><span class="p">],[</span><span class="s">&#39;c&#39;</span><span class="p">,</span><span class="s">&#39;Complete empty columns of first record with second record values where possible&#39;</span><span class="p">],[</span><span class="s">&#39;[Enter]&#39;</span><span class="p">,</span><span class="s">&#39;Keep first record and delete second&#39;</span><span class="p">],[</span><span class="s">&#39;abort&#39;</span><span class="p">,</span><span class="s">&#39;Abort merge of current table, undo all changes, and proceed to next table&#39;</span><span class="p">]],</span> <span class="n">title</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">)</span>
    <span class="n">replace</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&quot;Keep both records [k]? Or replace [r], complete [c], or keep only [Press *Enter*] record {}? (Type column name to inspect or &#39;help&#39; for options): &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

  <span class="k">if</span> <span class="n">replace</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">all</span><span class="p">([</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span><span class="o">+</span><span class="n">options</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">replace</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span> <span class="ow">or</span> <span class="n">replace</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;sql&#39;</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">replace</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s">&#39;r&#39;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">replace</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s">&#39;r&#39;</span><span class="p">:</span>
        <span class="n">sure</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;Are you sure you want to replace record {} with record {}? [y/n] : &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">new</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">sure</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s">&#39;y&#39;</span><span class="p">:</span>
          <span class="n">empty_cols</span><span class="p">,</span> <span class="n">new_vals</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[[</span><span class="s">&#39;{}=?&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">),</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span><span class="p">,</span><span class="n">n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="n">new</span><span class="p">[</span><span class="mi">1</span><span class="p">:])])</span>
          <span class="k">if</span> <span class="n">delete</span><span class="p">:</span> <span class="n">db</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;DELETE FROM {} WHERE id={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">new</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
          <span class="n">db</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;UPDATE {} SET {} WHERE id={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">empty_cols</span><span class="p">),</span> <span class="n">old</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">new_vals</span><span class="p">)),</span> <span class="n">db</span><span class="o">.</span><span class="n">modify</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="k">elif</span> <span class="nb">all</span><span class="p">([</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span><span class="o">+</span><span class="n">options</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">replace</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()]):</span>
        <span class="n">empty_cols</span><span class="p">,</span> <span class="n">new_vals</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[[</span><span class="s">&#39;{}=?&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">),</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span><span class="p">,</span><span class="n">n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="n">new</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="k">if</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">replace</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">empty_cols</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">delete</span><span class="p">:</span> <span class="n">db</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;DELETE FROM {} WHERE id={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">new</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
          <span class="n">db</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;UPDATE {} SET {} WHERE id={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">empty_cols</span><span class="p">),</span> <span class="n">old</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">new_vals</span><span class="p">)),</span> <span class="n">db</span><span class="o">.</span><span class="n">modify</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">replace</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s">&#39;c&#39;</span> <span class="ow">and</span> <span class="s">&#39;c&#39;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">empty_cols</span><span class="p">,</span> <span class="n">new_vals</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[[</span><span class="s">&#39;{}=?&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">),</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span><span class="p">,</span><span class="n">o</span><span class="p">,</span><span class="n">n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="n">old</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="n">new</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="k">if</span> <span class="nb">repr</span><span class="p">(</span><span class="n">o</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="s">&#39;null&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">repr</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="s">&#39;null&#39;</span><span class="p">]])</span>
        <span class="k">if</span> <span class="n">delete</span><span class="p">:</span> <span class="n">db</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;DELETE FROM {} WHERE id={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">new</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">db</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;UPDATE {} SET {} WHERE id={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">empty_cols</span><span class="p">),</span> <span class="n">old</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">new_vals</span><span class="p">)),</span> <span class="n">db</span><span class="o">.</span><span class="n">modify</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="k">except</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">delete</span><span class="p">:</span> <span class="n">db</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;DELETE FROM {} WHERE id={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">new</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">db</span><span class="o">.</span><span class="n">modify</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">replace</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s">&#39;k&#39;</span> <span class="ow">and</span> <span class="s">&#39;k&#39;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span> <span class="k">return</span> <span class="p">[</span><span class="n">old</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">new</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">elif</span> <span class="n">replace</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;sql &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s">&#39;sql&#39;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span> 
      <span class="k">try</span><span class="p">:</span> <span class="n">db</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">replace</span><span class="p">[</span><span class="mi">4</span><span class="p">:]),</span> <span class="n">db</span><span class="o">.</span><span class="n">modify</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
      <span class="k">except</span><span class="p">:</span> <span class="k">pass</span> 
  <span class="k">elif</span> <span class="n">replace</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s">&#39;abort&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#39;abort&#39;</span>
  <span class="k">elif</span> <span class="ow">not</span> <span class="n">replace</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">delete</span><span class="p">:</span> <span class="n">db</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="s">&quot;DELETE FROM {} WHERE id={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">new</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">db</span><span class="o">.</span><span class="n">modify</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">pass</span></div>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Joe Filippazzo.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>